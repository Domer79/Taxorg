@using System.Web.Optimization
@using MvcFileUploader.HtmlHelper
@using TaxOrg.Controllers
@using TaxorgRepository
@model dynamic

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section meta
{
    <meta http-equiv="PRAGMA" content="NO-CACHE">
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="CACHE-Control" content="NO-CACHE">
}

@functions{

    public string IsNotLoadSameLabel()
    {
        return TaxorgTools.IsNotSameTaxLoad ? "Добавить записи" : "Скрыть записи";
    }

}

@Scripts.Render("~/jqgrid")
@Scripts.Render("~/scripts/jqgridlocale")

@section main
{
    @string.Format("active")
}

<style type="text/css">
    .grid {
        margin-top: 50px;
    }

    .oddRow {
        font-size: 12px;
        font-weight: bold;
        background-image: url('~/Content/themes/overcast/images/ui-bg_flat_55_c0402a_40x100.png') !important;
    }
</style>
<div>
    <div class="grid container">
@*        <div>*@
@*            <a href="@Url.Action("Index", "Uploader")" class="btn btn-large btn-primary">Загрузить файл</a>*@
@*        </div>*@

        <table id="tOrg" style="width: 100%"></table>
        <div id="tOrgPage"></div>

    </div>
</div>

@section scripts
{
<script type="text/javascript">
    $(document).ready(function () {

        var innEditOptions = {};
        innEditOptions.dataInit = function (elem) {
            $(elem).attr("readonly", "readonly").width(200);
        }

        var nameEditOptions = {};
        nameEditOptions.dataInit = function (elem) {
            $(elem).width(200);
        };

        var shortNameEditOptions = {};
        shortNameEditOptions.dataInit = function (elem) {
            $(elem).width(200);
        };

        var addressEditOptions = {};
        addressEditOptions.dataInit = function (elem) {
            $(elem).width(200);
        };

        //        var lastSel;

        $("#tOrg").jqGrid({
            url: "@Url.Action("GetData")",
            editurl: "@Url.Action("Edit")",
            datatype: "json",
            colModel: [
                { name: "IdOrganization", hidden: true, key: true, editable: true, searchoptions: { sopt: ['eq', 'ne'] } },
                { name: "Inn", label: "ИНН", editable: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }, editoptions: innEditOptions },
                { name: "Name", label: "Полное наименование организации", hidden: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }, editable: true, editrules: { edithidden: true }, editoptions: nameEditOptions },
                { name: "ShortName", width: 400, label: "Наименование организации", searchoptions: { sopt: ['cn', 'eq', 'ne'] }, editable: true, editoptions: shortNameEditOptions },
                { name: "Address", width: 300, label: "Адрес", searchoptions: { sopt: ['cn', 'eq', 'ne'] }, editable: true, editoptions: addressEditOptions },
                { name: "Tax", label: "Сумма", hidden: true, width: 100, searchoptions: { sopt: ['eq', 'ne', 'gt', 'ge', 'lt', 'le'] }, editable: false, formatter: "currency", formatoptions: { decimalSeparator: ".", thousandsSeparator: " ", decimalPlaces: 2 } },
                { name: "TaxDebitKredit", index: "Tax", label: "Сумма долга", width: 100, searchoptions: { sopt: ['eq', 'ne', 'gt', 'ge', 'lt', 'le'] }, editable: false },
                { name: "PrevTax", label: "На @ViewBag.PrevPeriod", width: 100, searchoptions: { sopt: ['eq', 'ne', 'gt', 'ge', 'lt', 'le'] }, editable: false, formatter: "currency", formatoptions: { decimalSeparator: ".", thousandsSeparator: " ", decimalPlaces: 2 } },
                { name: "Delta", label: "Дельта", width: 100, searchoptions: { sopt: ['eq', 'ne', 'gt', 'ge', 'lt', 'le'] }, editable: false, formatter: "currency", formatoptions: { decimalSeparator: ".", thousandsSeparator: " ", decimalPlaces: 2 } },
                { name: "PeriodName", width: 100, label: "Период", hidden: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }, editable: false }
            ],
            mtype: 'POST',
            pager: "#tOrgPage",
            rowNum: 25,
            //            page: 20,
            rowList: [10, 20, 30, @ViewBag.TotalTaxCount],
            sortName: "shortName",
            sortorder: "asc",
            shrinkToFit: true,
            jsonReader: {
                root: "rows",
                page: "page",
                total: "totalPages",
                records: "records",
                repeatitems: false,
                userdata: "userdata"
            },
            height: "auto",
            width: "100%",
            gridComplete: function () {
                $("tr:odd").addClass("oddRow");
                $(this).css("width", "100%");

            },
            ondblClickRow: function (rowId, iRow, iCol, e) {
                var data = $(this).getRowData(rowId);
                var parameters = "?idOrganization=" + data.IdOrganization;
                var url = "@Url.Action("Index", "Slice")" + parameters;
                $(location).attr("href", url);
            },
            caption: "Отчетный период: @TaxorgTools.GetCurrentPeriod()",
            toolbar: [true, "top"]
        });

        $("#tOrg").navGrid("#tOrgPage", {
            edit: true,
            add: false,
            del: true,
            refresh: true,
            searchtext: "Поиск",
            view: true,
            modal: true
        },
            //Edit parameters
            {
                id: 'myedit',
                editCaption: "Редактирование записи",
                closeAfterEdit: true,
                reloadAfterSubmit: true,
                width: 500
            },
            //Add parameters
            {
//                id: 'myadd',
//                addCaption: "Добавление новой записи",
//                width: 500,
//                saveData: "Data has been changed! Save changes?",
//                closeAfterAdd: true,
//                recreateForm: true,
//                modal: true,
                //ajaxEditOptions: {
                //    error: function (xhr, textStatus, errorThrown) {
                //        alert("Error");
                //    }
                //}
            },
            //Delete parameters
            {
                id: 'mydel',
                url: "@Url.Action("Delete")"
            },
            //Search parameters
            {
                closeOnEscape: true,
                multipleSearch: true,
                closeAfterSearch: true
            },
            //View parameters
            {
                width: 600
            }
        );

        $("#tOrg").jqGrid('filterToolbar', {
            searchOperators: true,
            stringResult: true
        });

        $("#editDialog").dialog({
            modal: true,
            autoOpen: false
        });

        $("#t_tOrg")
            .attr("role", "group")
            .addClass("btn-group btn-group-xs");
//            .css("height", "30px");

        $("#t_tOrg").append('<input type="button" id="hideSameRows" class="btn btn-default" value="@IsNotLoadSameLabel()" style="height: 19px" title="Запрещает/Разрешает загрузку данных с одинаковыми значениями сумм долга за текущий и предыдущий периоды" />');

        $("#hideSameRows").click(function() {
            alert("Заработало!!!");
        });
//        $("#t_tOrg").append('<input type="button" class="btn btn-default" value="Middle" style="height: 28px" />');
//        $("#t_tOrg").append('<input type="button" class="btn btn-default" value="Right" style="height: 28px" />');
//        $("#t_tOrg").append("<input type='button' value='Click Me' style='height:20px;font-size:-3'/>");
    });
</script>   
}

<div class="btn-group">
    <button type="button" class="btn btn-primary" title="Запрещает/Разрешает загрузку данных с одинаковыми значениями сумм долга за текущий и предыдущий периоды">Action</button>
</div>